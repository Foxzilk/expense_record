// Handles OPTIONS preflight requests
function doOptions(e) {
  const headers = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type',
    'Access-Control-Max-Age': '86400',
    'Content-Type': 'application/json'
  };
  
  return ContentService.createTextOutput(JSON.stringify({status: "preflight ok"}))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeaders(headers);
}

// Handles POST requests for saving expenses
function doPost(e) {
  try {
    // Validate request data
    if (!e || !e.postData) {
      throw new Error('Invalid request - missing data');
    }
    
    // Parse JSON data safely
    let expenseData;
    try {
      expenseData = JSON.parse(e.postData.contents);
    } catch (parseError) {
      throw new Error('Invalid JSON format: ' + parseError.message);
    }
    
    // Validate required fields
    if (!expenseData.date || !expenseData.amount || !expenseData.category) {
      throw new Error('Missing required fields - please include date, amount, and category');
    }
    
    // Get spreadsheet and append data
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    
    // Ensure header row exists (create if missing)
    const headerRow = sheet.getRange(1, 1, 1, 4).getValues()[0];
    if (headerRow[0] !== 'Date' || headerRow[1] !== 'Amount' || 
        headerRow[2] !== 'Category' || headerRow[3] !== 'Description') {
      sheet.getRange(1, 1, 1, 4).setValues([
        ['Date', 'Amount', 'Category', 'Description']
      ]);
    }
    
    // Append new expense
    sheet.appendRow([
      expenseData.date,
      parseFloat(expenseData.amount),
      expenseData.category,
      expenseData.description || ''
    ]);
    
    // Return success response with CORS headers
    return ContentService.createTextOutput(JSON.stringify({
      status: "success",
      message: "Expense saved successfully",
      data: expenseData
    }))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeaders({
      'Access-Control-Allow-Origin': '*',
      'Content-Type': 'application/json',
      'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type'
    });
    
  } catch (error) {
    // Return error response with CORS headers
    return ContentService.createTextOutput(JSON.stringify({
      status: "error",
      message: error.message
    }))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeaders({
      'Access-Control-Allow-Origin': '*',
      'Content-Type': 'application/json'
    });
  }
}

// Handles GET requests for fetching expenses
function doGet(e) {
  try {
    // Get spreadsheet data
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    const data = sheet.getDataRange().getValues();
    
    // Check if there's data beyond headers
    if (data.length <= 1) {
      return ContentService.createTextOutput(JSON.stringify([]))
        .setMimeType(ContentService.MimeType.JSON)
        .setHeaders({
          'Access-Control-Allow-Origin': '*',
          'Content-Type': 'application/json'
        });
    }
    
    // Process and format expenses
    const expenses = data.slice(1).map((row, index) => ({
      id: index + 1,
      date: row[0],
      amount: row[1],
      category: row[2],
      description: row[3] || ''
    }));
    
    // Return expenses with CORS headers
    return ContentService.createTextOutput(JSON.stringify(expenses))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeaders({
      'Access-Control-Allow-Origin': '*',
      'Content-Type': 'application/json',
      'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type'
    });
    
  } catch (error) {
    // Return error response with CORS headers
    return ContentService.createTextOutput(JSON.stringify({
      status: "error",
      message: error.message
    }))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeaders({
      'Access-Control-Allow-Origin': '*',
      'Content-Type': 'application/json'
    });
  }
}
    
